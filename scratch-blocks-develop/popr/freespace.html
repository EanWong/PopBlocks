<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>PopBlocks</title>

    <script src="../blockly_uncompressed_horizontal.js"></script>
    <script src="../popr_uncompressed.js"></script>
    <script src="../msg/messages.js"></script>
    <script src="../blocks_common/math.js"></script>
    <script src="../blocks_common/text.js"></script>
    <script src="../popr_blocks/control.js"></script>
    <script src="../popr_blocks/event.js"></script>
    <script src="../popr_blocks/wedo.js"></script>
    <script src="../popr_blocks/malle.js"></script>
    <script src="../popr_blocks/default_toolbox.js"></script>
    <script>
	  function toggleSidenav() {
        var nav = document.getElementById("sidenav");
        if (nav.style.display == "block") {
          nav.className = "sidenav-up";
          setTimeout(function(){
      	    nav.style.display = "none";
		  }, 400);
        } else {
	      nav.className = "sidenav-down";
	      setTimeout(function(){
	        nav.style.display = "block";
		  }, 400);
        }
	  }
	  
    </script>
    <script>
      'use strict';

     var workspace = null;
     var live = window.location.href.startsWith("http://"); // whether or not this is live or just on computer
     
      function start() {
        // Setup blocks
        // Parse the URL arguments.
        workspace = Blockly.inject('blocklyDiv', {
          comments: true,
          disable: false,
          collapse: false,
          media: '../media/',
          readOnly: false,
          rtl: false,
          scrollbars: true,
          toolbox: null,
          trashcan: true,
          playControls: true,
          horizontalLayout: true,
          toolboxPosition: 'start',
          sounds: true,
          grid: {spacing: 55,
            length: 2,
            colour: '#FFF',
            snap: true
          },
          zoom: {
            controls: false,
            wheel: true,
            startScale: 1.1,
            maxScale: 4,
            minScale: 0.25,
            scaleSpeed: 1.1
          },
          colours: {
            workspace: '#334771',
            toolbox: '#24324D',
            flyout: '#283856',
            scrollbar: '#24324D',
            scrollbarHover: '#0C111A',
            insertionMarker: '#FFFFFF',
            insertionMarkerOpacity: 0.3,
            fieldShadow: 'rgba(255, 255, 255, 0.3)',
            dragShadowOpacity: 0.6
          }
      });
		
     // should look for # and take everything after
     var number = parseFloat(window.location.href.slice(-1));
     if (!isNaN(number)) {
     	loadWorkspace(number);
     }
	  workspace.addChangeListener(updateFunction);
	  populateNav();
      }
    
      function showAndroidToast(toast) {
        Android.showToast(toast);
      }

      function sendCommand(command) {
        Android.sendCommand(command);
      }

      function saveRule(rule) {
        Android.saveRule(rule);
        console.log(rule);
      }

      function deleteRule(rule) {
        Android.deleteRule(rule);
      }

      function deleteAllRules() {
      	workspace.clear()
        Android.deleteAllRules();
      }
      
      function saveWorkspace() {
      	var xml = Blockly.Xml.workspaceToDom(workspace);
      	var xml_text = Blockly.Xml.domToText(xml)
      	if (live) {
	      Android.saveWorkspace(xml_text);
	    } else {
	      console.log(xml_text);
	    }
      }
      
      function addWedo() {
      	Android.addWedo();
      }
      
      function addRobot() {
      	Android.addRobot();
      }
      
      function populateNav() {
        var count;
      	if (live) {
      	  count = Android.numPrograms();
      	} else {
      	  count = 10; // 10;
      	}
      	var prog = document.getElementById("programs");
      				  	
      	for (let i=0; i<count; i++) {
      		var a = document.createElement('a');
			var img = document.createElement('img');
			img.src = "../media/piece" + (i%7+1) + ".svg";
			img.alt = "Prog " + (i+1);
			a.appendChild(img);
			a.href = "#";
			a.onclick = function() { 
				loadWorkspace(i+1); 
		        toggleSidenav(); };
			a.className = "progLink";
			prog.appendChild(a);
      	}
      }
      
      function toggleWorkspaces() {
        var prog = document.getElementById("programs");
        if (prog.style.display == "initial") {
          setTimeout(function(){
      	    prog.style.display = "none";
		  }, 100);
        } else {
	      setTimeout(function(){
	        prog.style.display = "initial";
		  }, 100);
        }
      }
      function loadWorkspace(number) {
        if (live) {
    	  var xml_text = Android.loadWorkspace(number);
      	  var xml = Blockly.Xml.textToDom(xml_text);
      	  Blockly.Xml.domToWorkspace(xml, workspace);
      	
	      var code = Blockly.Popr.workspaceToCode(workspace);
	      Android.saveRule(code);
	    } else {
	      console.log("Loading program " + number);
	    }
      }
      
      function updateFunction(event) {
	    var code = Blockly.Popr.workspaceToCode(workspace);
	    
	    // Log event
	    if (live) {
		    Android.log(Date.now() + "\t" + event.type + "\t" + event.element + "\t" + event.newValue + "\t" + code + "\n");
		}
		
		// Sort events into Android commands
        if (event.type == Blockly.Events.UI) {
          if (event.element == 'click' || event.element == 'toolboxclick') {
            var block = workspace.getBlockById(event.blockId);
            var code = "";
  			while (block != null) {
  	  		  code += Blockly.Popr.blockToCode(block);
  	  		  block = block.getNextBlock();
  	  		}
  	  		
  	  		if (live) {
	            Android.sendCommand(code);
            } else {
	  	  		console.log(event.element + ' ' + code);
  	  		}
  	  		
          } else if (event.element == 'categoryclick') {
          
  	  		if (!live) {
	          	console.log(event.element + ' ' + event.oldValue + ' ' + event.newValue);
            }
          } else if (event.element == 'stop') {
        	if (live) {
        		Android.stopTrigger();
        	} else {
        		console.log(event.element);	
        	}
        	
          } else if (event.element == 'play') {
        	if (live) {
	        	Android.startTrigger();
        	} else {
        		console.log(event.element);	
        	}
          } else if (event.element == 'trashcan') {
        	workspace.clear();
        	if (live) {
	        	Android.deleteAllRules();
        	} else {
        		console.log(event.element);	
        	}
          }
      } else if (event.type == Blockly.Events.RECORD) {
      	//console.log('record' + event.filename + '.wav');
      } else {
      	if (live) {
	      Android.resetRules(code);
       	} else {
       		console.log(event.code);	
       	}
      }
    }
      
    </script>
	<link rel="stylesheet" type="text/css" href="index.css"> 
  </head>

  <body onload="start()">
    <nav class="sidenav-up" id="sidenav">
      <div>
      	<a href="index.html" class="navLink"><img src="../media/icons/back.svg" alt="Back"></a>
	    <a href="#" onclick="saveWorkspace()" class="navLink"><img src="../media/save.svg" alt="Save"></a>
	    <a href="#" onclick="toggleWorkspaces()" class="navLink"><img src="../media/open.svg" alt="Load Workspace">
			<div id="programs"></div>
	    </a>
	    <a href="#" onclick="addWedo()" class="navLink"><img src="../media/icons/wedo_add.svg" alt="Wedo"></a>
	    <a href="#" onclick="addRobot()" class="navLink"><img src="../media/icons/add_robot.svg" alt="Robot"></a>
	    <div class="menuButton" onclick="toggleSidenav()">&#x25B2;</div>
	  </div>
	</nav>	
	<div class="menuButton" onclick="toggleSidenav()">&#x25BC;</div>
    <div id="blocklyDiv"></div>
  </body>
</html>
